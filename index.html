<!DOCTYPE html>
<html>
    <head>
        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="dist/bootstrap-treeview.min.css" rel="stylesheet" type="text/css" />
        <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.0.0/handlebars.js"></script>
        <script src="dist/bootstrap-treeview.min.js"></script>
        <meta charset="utf-8">
        <title>Aura</title>
    </head>
    <body>
    
	<div class="row">
		<div class="col-md-12">
			<div style="padding:10px;">
				<div>
					<h1>
						Dependencies Tree | <a href='./index.usage.html'>Usage Table</a>
						<button id="btnExpandAll" class="btn btn-primary" style="float:right; cursor:pointer"> + Expand All</button>

						<button id="btnCollapseAll" class="btn" style="float:right; cursor:pointer; margin-right:20px;"> - Collapse All</button>
					</h1>
				</div>
				<div><input id="searchComponent" placeholder="Component To Search" style="width:100%" /></div>
				<div id="tree"></div>
			</div>
		</div>
	</div>


	<script id="tmplContentDepRow" type="text/x-handlebars-template">
	<tr>
		<td>{{cmp}}</td>
		<td>{{cmpDep}}</td>
		<td>{{count}}</td>
	</tr>
	</script>


    <script>
	$.debounce = function(ts, func){
		var timer;

		return function(){
			if(timer){
				clearTimeout(timer);
			}
			
			timer = setTimeout(function(){
				func();
			}, ts | 500);
		}
	}

    $.get('./stat/depHash.json', function(r){
    	//draw the trees
    	var treeData = [];
    	var appNode = createTreeNode('app', true, 'lvl_0', '#FFF', '#000');
    	var cmpNode = createTreeNode('cmp', true, 'lvl_0', '#FFF', '#000');

    	treeData.push(appNode);
    	treeData.push(cmpNode);

    	for (var k in r){
    		var cmpName = k;
    		var curNode = createTreeNode(cmpName, true, 'lvl_1', '#FFF', '#444');
    		var totalDepdenciesUse = 0;
    		for (var cmpDep in r[k]){
    			var count = r[k][cmpDep].length;
    			var curChildNode = createTreeNode( cmpDep + ' (' + count + ')' , true, 'lvl_2', '#FFF', '#777');
    			curNode.nodes.push(
    				curChildNode
				);

				totalDepdenciesUse++;

				//generate attributes in tag
				for (var i = 0; i < r[k][cmpDep].length;i++){
					var curGrandChildNode = createTreeNode(cmpDep + '['+i+']', false, 'lvl_3', '#FFF', '#AAA');
					curChildNode.nodes.push(
						curGrandChildNode
					);

					if(Object.keys(r[k][cmpDep][i]).length > 0){
						curGrandChildNode.nodes = [];

						$.each(r[k][cmpDep][i], function(attrName, attrVal){
							//simple mode
							curGrandChildNode.nodes.push(
								createTreeNode( '<b class="text-info" style="text-decoration:underline">'+attrName+':</b> ' + attrVal, false, 'lvl_4')
							);

							// //full on mode
							// var nameNode = createTreeNode( attrName, true, 'lvl_4');
							// var valNode = createTreeNode( attrVal, false, 'lvl_5');
							// nameNode.nodes.push(
							// 	valNode
							// );
							// nameNode.state.expanded = true;
							// // valNode.state.expanded = true;

							// curGrandChildNode.nodes.push(
							// 	nameNode
							// );
						});
					}
				}
    		}


			curNode.text = curNode.text.substr(4, curNode.text.length) + " (" + totalDepdenciesUse + ")"

			if(cmpName.indexOf('app.') === 0){
				appNode.nodes.push(curNode);	
			}
			else{
				cmpNode.nodes.push(curNode);
			}
    	}

    	function createTreeNode (name, hasChild, tag, color, bgcolor){
    		return {
    			text : name,
    			nodes: hasChild ? [] : undefined,
    			color: color || '#000',
  				backColor: bgcolor || '#fff',
  				state: {
					// checked: true,
					// disabled: true,
					expanded: false,
					selected: false
				},
				icon: tag
    		}
    	}


    	$('#tree').treeview({
		  data: treeData,         // data is not optional
		  levels: 5,
		  highlightSelected: false
		  // highlightSearchResults: false
		});
    });
	

	$('#btnExpandAll').click(function(){
		$('#tree').treeview('expandAll');		
	});

	$('#btnCollapseAll').click(function(){
		$('#tree').treeview('collapseAll');		
	});
	


    $('#searchComponent').keypress(
    	$.debounce(
    		500,
    		function(){
    			var keyword = $('#searchComponent').val();
    			$('#tree').treeview( 'search' , [ keyword, {
				  ignoreCase: true,     // case insensitive
				  exactMatch: false,    // like or equals
				  revealResults: true,  // reveal matching nodes
				}]);
		    }
		)
	);
    </script>
</body>
</html>