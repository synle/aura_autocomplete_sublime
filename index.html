<!DOCTYPE html>
<html>
    <head>
        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="dist/bootstrap-treeview.min.css" rel="stylesheet" type="text/css" />
        <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.0.0/handlebars.js"></script>
        <script src="dist/bootstrap-treeview.min.js"></script>
        <meta charset="utf-8">
        <title>Aura</title>
    </head>
    <body>
    
	<div class="row">
		<div class="col-md-6">
			<div style="border:1px solid tomato">
				<!-- <div>
					<h2>Dependencies Table</h2>
					<hr />
				</div>
				<table class="table table-striped">
					<thead>
						<tr>
							<th>Component</th>
							<th>Dependencies</th>
							<th>Count</th>
						</tr>
					</thead>
					<tbody id="tblContentDep"></tbody>
				</table> -->

				<div><h2>Dependencies Tree</h2></div>
				<div><input id="searchComponent" placeholder="Component To Search" style="width:100%" /></div>
				<div id="tree"></div>
			</div>
		</div>
		<div class="col-md-6">
			<div style="border:1px solid purple">
				<div>
					<h2>Usage Table</h2>
					<hr />
				</div>
				<table class="table table-striped">
					<thead>
						<tr>
							<th>Component</th>
							<th>Usage</th>
						</tr>
					</thead>
					<tbody id="tblUsage"></tbody>
				</table>
			</div>
		</div>
	</div>


	<script id="tmplContentDepRow" type="text/x-handlebars-template">
	<tr>
		<td>{{cmp}}</td>
		<td>{{cmpDep}}</td>
		<td>{{count}}</td>
	</tr>
	</script>


	<script id="tmplUsageRow" type="text/x-handlebars-template">
	<tr>
		<td>{{cmp}}</td>
		<td>{{count}}</td>
	</tr>
	</script>

    <script>
	$.debounce = function(ts, func){
		var timer;

		return function(){
			if(timer){
				clearTimeout(timer);
			}
			
			timer = setTimeout(function(){
				func();
			}, ts | 500);
		}
	}
    
    $.get('./mappings.orig.json', function(r){
    	var source   = $("#tmplContentDepRow").html();
    	var template = Handlebars.compile(source);
    	var body = $('#tblContentDep');

    	// for (var k in r){
    	// 	var cmpName = k;
    	// 	for (var cmpDep in r[k]){
    	// 		var count = r[k][cmpDep];
    	// 		body.append(template({
    	// 			cmp: cmpName,
    	// 			cmpDep: cmpDep,
    	// 			count : count
    	// 		}));
    	// 	}
    	// }

    	//draw the trees
    	var treeData = [];
    	for (var k in r){
    		var cmpName = k;
    		var curNode = createTreeNode(cmpName, true);
    		var totalDepdenciesUse = 0;
    		for (var cmpDep in r[k]){
    			var count = r[k][cmpDep];

    			curNode.nodes.push(
    				createTreeNode( cmpDep + ' (' + count + ')' , false )
				);

				totalDepdenciesUse++;
    		}

    		curNode.color = "#FFFFFF";
			curNode.backColor = "#000000";
			curNode.text += " (" + totalDepdenciesUse + ")"

    		treeData.push(curNode);
    	}

    	function createTreeNode (name, hasChild){
    		return {
    			text : name,
    			nodes: hasChild ? [] : undefined,
    			color: "#000000",
  				backColor: "#FFFFFF",
  				state: {
					// checked: true,
					// disabled: true,
					expanded: false,
					selected: false
				}
    		}
    	}


    	$('#tree').treeview({
		  data: treeData,         // data is not optional
		  levels: 5,
		  backColor: 'green'
		});
    });

    $.get('./mappings.reverse.json', function(r){
    	var source   = $("#tmplUsageRow").html();
    	var template = Handlebars.compile(source);
    	var body = $('#tblUsage');

    	for (var k in r){
    		var cmpName = k;
    		body.append(template({
				cmp: cmpName,
				count : r[k]
			}));
    	}
    });

    $('#searchComponent').keypress(
    	$.debounce(
    		500,
    		function(){
		    	var keyword = $('#searchComponent').val();
		    	$('.expand-icon').each(function(){
		    		var parentLi = $(this).closest('li');
		    		var componentName = $.trim(parentLi.text());
		    		if (componentName.toLowerCase().indexOf(keyword.toLowerCase()) >= 0){
		    			parentLi.show();
		    		}
		    		else{
		    			parentLi.hide();
		    		}
		    	});
		    }
		)
	);
    </script>
</body>
</html>