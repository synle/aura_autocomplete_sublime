<!DOCTYPE html>
<html>
    <head>
        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="dist/bootstrap-treeview.min.css" rel="stylesheet" type="text/css" />
        <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <script src="dist/bootstrap-treeview.min.js"></script>
        <meta charset="utf-8">
        <title>Aura</title>
    </head>
    <body>

    <style>
	.box
	{
		font-weight:bold;
 		padding:10px;
 		font-size:1em;
 		border:1px solid #EEE;
 		box-sizing:border-box;
 		overflow: hidden;
	}

	/*.box:hover
	{
		border-left: 5px solid tomato;
	}*/

	.lvl_0{
 	}
	.lvl_1{
		background-color:#333;
		color:#FFF;
	}
	.lvl_1 b.ticker{
		float:right;
		color:#68B4F6;
	}
	.box b.ticker_2{
		color: rgb(122, 247, 126);
	}
	.lvl_2{
		background-color:#666;
		color:#FFF;
		margin-left: 50px;
		cursor:pointer;
	}
	.lvl_3{
		background-color:#999;
		color:#FFF;
		margin-left: 100px;
		display:none;
	}
	.lvl_4{
		background-color:#DDD;
		color:#000;
		margin-left: 150px;
		display:none;
	}

	.lvl_4 > b {
		text-decoration:underline;
		margin-right:20px;
	}

	.selected{
		border-left:5px solid #6f5499;
	}

	.visible {
		display: block !important;
	}


	#loading{
		background-color:tomato;
		text-align:center;
		color:#FFF;
		text-shadow: 1px 1px #CCC;
		position:fixed;
		top:0;
		left:0;
		width:100%;
		padding-left:5px;
		padding-right:5px;
		box-sizing:border-box;
	}

	.search-hl .box{
		display:none !important;
	}
	</style>

    
	<div class="container-fluid">
		<div style="padding:10px">
			<div class="row">
				<div class="col-md-12">
					<div id="loading" class="row"></div>
					<div class="row">
						<h1>
							Dependencies Tree | <a href='./index.usage.html'>Usage Table</a>
							<button id="btnExpandAll" class="btn btn-primary" style="float:right; cursor:pointer"> + Expand All</button>
							<button id="btnCollapseAll" class="btn" style="float:right; cursor:pointer; margin-right:20px;"> - Collapse All</button>
						</h1>
					</div>
					<div class="row">
						<input id="searchComponent" placeholder="Component To Search" style="width:100%" />
					</div>
					<div id="tree" class="row"></div>
				</div>
			</div>
		</div>
	</div>


    <script>
    var taskScheduler = new TaskScheduler(50);
	$.debounce = function(ts, func){
		var timer;

		return function(){
			if(timer){
				clearTimeout(timer);
				timer = undefined;
			}

			$('#loading').width('100%').html('Loading...');
			timer = setTimeout(function(){
				func();
				$('#loading').empty().hide();
			}, ts | 500);
		}
	}

    $.get('./stat/depHash.json', function(r){
    	// drawTree(r);
    	drawPlainDom(r)
    });

    function drawPlainDom(r){
    	$("#tree").empty();

    	var jobQueues = [];

    	for (var key in r){
    		taskScheduler.schedule(
    			(function(k){
	    			return function(){
	    				var cmpName = k;
	    				var formattedName = cmpName.indexOf('app.') === 0 ? '<b class="ticker">app</b> ' : '<b class="ticker">cmp</b> ';
	    				formattedName += cmpName.substr(cmpName.indexOf('.') + 1)

						var wrapper_1 = createDomNode(
							formattedName,
							true,
							'lvl_1',
							'#tree'
						)
			    			
			    		var totalDepdenciesUse = 0;

			    		for (var cmpDep in r[k]){
			    			var count = r[k][cmpDep].length;
							var wrapper_2 = createDomNode(
								cmpDep + '<b class="ticker">' + count + '</b>',
								true,
								'lvl_2',
								wrapper_1
							)


							totalDepdenciesUse++;

							//generate attributes in tag
							for (var i = 0; i < r[k][cmpDep].length;i++){
								var wrapper_3 = createDomNode(
									cmpDep + ' [<b class="ticker_2">'+i+'</b>]',
									false,
									'lvl_3',
									wrapper_2
								)


								if(Object.keys(r[k][cmpDep][i]).length > 0){
									$.each(r[k][cmpDep][i], function(attrName, attrVal){
										//simple mode
										createDomNode(
											'<b>'+attrName+':</b> ' + escapeHtml(attrVal),
											false,
											'lvl_4',
											wrapper_3
										)
									});
								}
							}
			    		}
	    			}
	    		})(key)
			);
    	}


    	//start the start scheduler
    	taskScheduler.start();


		//hook up events
		hookupEvents()
    }


	//hook up events
	function hookupEvents(){
	    $('#searchComponent').keypress(
	    	$.debounce(
	    		500,
	    		function(){
	    			var keyword = $('#searchComponent').val();
					$('#tree').toggleClass('search-hl', keyword.length === 0);

	    			$('.box').each(function(){
	    				var isVisible = false;
	    				if ($(this).text().indexOf(keyword) >= 0){
	    					isVisible = true;
	    				}
	    			});
			    }
			)
		);


	    //click to select
		// $('#tree').on('click', '.box', function(){
		// 	$(this).toggleClass('selected');
		// });


		$('#btnExpandAll').click(function(){	
			$('.box:not(.visible)').addClass('visible');
		});

		$('#btnCollapseAll').click(function(){
			$('.box.visible').removeClass('visible');
		});



		//click to expand each box
		$('#tree').on('click', '.box', function(e){
			$(this).children('.box').toggleClass('visible');
			e.stopPropagation();
			e.preventDefault();
		});
	}


	var escapeHtml = (function(){
		var entityMap = {
			"&": "&amp;",
			"<": "&lt;",
			">": "&gt;",
			'"': '&quot;',
			"'": '&#39;',
			"/": '&#x2F;'
		};

		return function (string) {
			return String(string).replace(/[&<>"'\/]/g, function (s) {
				return entityMap[s];
			});
		}
	})();


	function createDomNode (name, hasChild, tag, parent){
		return $('<div class="box '+tag+'" />').html(name).appendTo(parent);
	}

	function TaskScheduler(batchSize, intervalLength){
		batchSize = batchSize || 100;//size of batch at a time
		intervalLength = intervalLength || 200;//interval length

		var jobQueues = [];

		return {
			schedule: function(func){
				jobQueues.push(func);
			},
			reset: function(){
				jobQueues = [];
			},
			start: function(newBatchSize, newIntervalLen){
				newBatchSize = newBatchSize || batchSize;
				newIntervalLen = newIntervalLen || intervalLength;

				var maxJobs = jobQueues.length;
		    	var actionHandlerFunc = function(){
		    		if (jobQueues.length > 0){
		    			var curBatchSizeLeft = newBatchSize;
		    			while(curBatchSizeLeft > 0){
		    				curBatchSizeLeft--;

		    				var firstFunc = jobQueues.pop();
			    			if (typeof firstFunc === 'function'){
			    				firstFunc();
			    			}
		    			}

		    			//update loading progress
		    			var percent = parseInt(((maxJobs - jobQueues.length) / maxJobs) * 100) + '%';
		    			$('#loading').width(percent).html(percent);
		    		}
		    		else{
		    			clearInterval(actionScheduler);
		    			$('#loading').hide();
		    		}
		    	};


		    	//show loading
		    	$('#loading').show().empty();
		    	actionHandlerFunc();//start the first action
		    	var actionScheduler = setInterval(actionHandlerFunc, newIntervalLen);
			}
		}
	}
    </script>
</body>
</html>